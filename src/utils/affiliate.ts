// ---------------------------------------------------------
// æ›¸ç±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ & æœ€é©åŒ–ãƒ­ã‚¸ãƒƒã‚¯
// ---------------------------------------------------------

export type AffiliateMode = "STUDENT" | "TOEIC";

const makeRakutenLink = (title: string) => {
  const encoded = encodeURIComponent(title);
  return `https://search.rakuten.co.jp/search/mall/${encoded}/?scid=af_sp_etc&sc2id=af_101_0_0`;
};

export const getAffiliateByMode = (text: string, mode: AffiliateMode) => {
  const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
  const isLong = wordCount >= 80;

  // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
  const shuffle = (array: string[]) => {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
  };

  // =========================================================
  // ğŸ“š æ›¸ç±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (å„30å†Šä»¥ä¸Š)
  // =========================================================

  // A. ğŸ“ å­¦ç”Ÿ Ã— é•·æ–‡ (èª­è§£ãƒ»è§£é‡ˆãƒ»æ¼”ç¿’)
  const studentLongBooks = [
    "ã‚„ã£ã¦ãŠããŸã„è‹±èªé•·æ–‡300", "ã‚„ã£ã¦ãŠããŸã„è‹±èªé•·æ–‡500", "ã‚„ã£ã¦ãŠããŸã„è‹±èªé•·æ–‡700", "ã‚„ã£ã¦ãŠããŸã„è‹±èªé•·æ–‡1000",
    "ãƒãƒ¬ãƒãƒ¬è‹±æ–‡èª­è§£ãƒ—ãƒ­ã‚»ã‚¹50", "è‹±æ–‡èª­è§£ã®é€è¦–å›³", "åŸºç¤è‹±æ–‡è§£é‡ˆã®æŠ€è¡“100", "å…¥é–€è‹±æ–‡è§£é‡ˆã®æŠ€è¡“70",
    "å¤§å­¦å…¥è©¦ è‹±èªé•·æ–‡ãƒã‚¤ãƒ‘ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¬ãƒ™ãƒ«1", "å¤§å­¦å…¥è©¦ è‹±èªé•·æ–‡ãƒã‚¤ãƒ‘ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¬ãƒ™ãƒ«2", "å¤§å­¦å…¥è©¦ è‹±èªé•·æ–‡ãƒã‚¤ãƒ‘ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¬ãƒ™ãƒ«3",
    "é–¢æ­£ç”Ÿã®The Rules è‹±èªé•·æ–‡å•é¡Œé›† 1", "é–¢æ­£ç”Ÿã®The Rules è‹±èªé•·æ–‡å•é¡Œé›† 2", "é–¢æ­£ç”Ÿã®The Rules è‹±èªé•·æ–‡å•é¡Œé›† 3", "é–¢æ­£ç”Ÿã®The Rules è‹±èªé•·æ–‡å•é¡Œé›† 4",
    "é–¢æ­£ç”Ÿã®è‹±èªé•·æ–‡ãƒãƒ©ãƒªã‚¹ 1", "é–¢æ­£ç”Ÿã®è‹±èªé•·æ–‡ãƒãƒ©ãƒªã‚¹ 2", "é–¢æ­£ç”Ÿã®è‹±èªé•·æ–‡ãƒãƒ©ãƒªã‚¹ 3",
    "è‹±èªé•·æ–‡ãƒ¬ãƒ™ãƒ«åˆ¥å•é¡Œé›† 3 æ¨™æº–ç·¨", "è‹±èªé•·æ–‡ãƒ¬ãƒ™ãƒ«åˆ¥å•é¡Œé›† 4 ä¸­ç´šç·¨", "è‹±èªé•·æ–‡ãƒ¬ãƒ™ãƒ«åˆ¥å•é¡Œé›† 5 ä¸Šç´šç·¨", "è‹±èªé•·æ–‡ãƒ¬ãƒ™ãƒ«åˆ¥å•é¡Œé›† 6 é›£é–¢ç·¨",
    "ã‚¤ãƒã‹ã‚‰é›ãˆã‚‹è‹±èªé•·æ–‡300", "ã‚¤ãƒã‹ã‚‰é›ãˆã‚‹è‹±èªé•·æ–‡500", "ã‚¤ãƒã‹ã‚‰é›ãˆã‚‹è‹±èªé•·æ–‡700",
    "å…¨ãƒ¬ãƒ™ãƒ«å•é¡Œé›† è‹±èªé•·æ–‡ 3 ç§å¤§æ¨™æº–ãƒ¬ãƒ™ãƒ«", "å…¨ãƒ¬ãƒ™ãƒ«å•é¡Œé›† è‹±èªé•·æ–‡ 4 ç§å¤§ä¸Šä½ãƒ¬ãƒ™ãƒ«",
    "å¤§å­¦å…¥è©¦ è‚˜äº•å­¦ã® èª­è§£ã®ãŸã‚ã®è‹±æ–‡æ³•ãŒé¢ç™½ã„ã»ã©ã‚ã‹ã‚‹æœ¬",
    "å¤§å­¦å…¥è©¦ è‹±æ–‡è§£é‡ˆã‚¯ãƒ©ã‚·ãƒƒã‚¯", "è‹±æ–‡æ³•ãƒ»èªæ³• è‰¯å•500 èª¤æ–‡è¨‚æ­£ç·¨",
    "æ€è€ƒè¨“ç·´ã®å ´ã¨ã—ã¦ã®è‹±æ–‡è§£é‡ˆ", "è‹±æ–‡è§£é‡ˆæ•™å®¤", "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è‹±æ–‡è§£é‡ˆ"
  ];

  // B. ğŸ“ å­¦ç”Ÿ Ã— çŸ­æ–‡ (å˜èªãƒ»æ–‡æ³•ãƒ»ç†Ÿèª)
  const studentShortBooks = [
    "è‹±å˜èªã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900", "è‹±å˜èªã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1400", "è‹±å˜èªã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1200",
    "ã‚·ã‚¹ãƒ†ãƒ è‹±å˜èª", "ã‚·ã‚¹ãƒ†ãƒ è‹±å˜èª Basic",
    "é€Ÿèª­è‹±å˜èª å¿…ä¿®ç·¨", "é€Ÿèª­è‹±å˜èª ä¸Šç´šç·¨", "é€Ÿèª­è‹±ç†Ÿèª",
    "DUO 3.0", "é‰„ç·‘ä¼šæ±å¤§è‹±å˜èªç†Ÿèª é‰„å£",
    "LEAP è‹±å˜èª", "Stock 4500", "Stock 3000", "ãƒ¦ãƒ¡ã‚¿ãƒ³ 1", "ãƒ¦ãƒ¡ã‚¿ãƒ³ 2",
    "Next Stage è‹±æ–‡æ³•ãƒ»èªæ³•å•é¡Œ", "Vintage è‹±æ–‡æ³•ãƒ»èªæ³•", "Scramble è‹±æ–‡æ³•ãƒ»èªæ³•", "Power Stage è‹±æ–‡æ³•ãƒ»èªæ³•",
    "è‹±æ–‡æ³•ãƒ»èªæ³• Vintage", "å…¨è§£èª¬ é »å‡ºè‹±æ–‡æ³•ãƒ»èªæ³•å•é¡Œ1000",
    "å¤§å²©ã®ã„ã¡ã°ã‚“ã¯ã˜ã‚ã®è‹±æ–‡æ³• è¶…åŸºç¤æ–‡æ³•ç·¨", "è‚˜äº•å­¦ã®ã‚¼ãƒ­ã‹ã‚‰è‹±æ–‡æ³•ãŒé¢ç™½ã„ã»ã©ã‚ã‹ã‚‹æœ¬",
    "é–¢æ­£ç”Ÿã®è‹±æ–‡æ³•ãƒãƒ©ãƒªã‚¹ 1", "é–¢æ­£ç”Ÿã®è‹±æ–‡æ³•ãƒãƒ©ãƒªã‚¹ 2", "é–¢æ­£ç”Ÿã®è‹±æ–‡æ³•ãƒãƒ©ãƒªã‚¹ 3",
    "æ·±ã‚ã¦è§£ã‘ã‚‹ï¼ è‹±æ–‡æ³• INPUT", "æ·±ã‚ã¦è§£ã‘ã‚‹ï¼ è‹±æ–‡æ³• OUTPUT",
    "è§£ä½“è‹±ç†Ÿèª", "è‹±ç†Ÿèªã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1000", "ã‚­ã‚¯ã‚¿ãƒ³ Entry 2000", "ã‚­ã‚¯ã‚¿ãƒ³ Basic 4000"
  ];

  // C. ğŸ¢ ç¤¾ä¼šäºº/TOEIC Ã— é•·æ–‡ (Part7ãƒ»æ¨¡è©¦ãƒ»å¤šèª­)
  const toeicLongBooks = [
    "å…¬å¼TOEIC Listening & Reading å•é¡Œé›† 10", "å…¬å¼TOEIC Listening & Reading å•é¡Œé›† 9", "å…¬å¼TOEIC Listening & Reading å•é¡Œé›† 8",
    "TOEIC L&R TEST ç²¾é¸æ¨¡è©¦ ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚° 3", "TOEIC L&R TEST ç²¾é¸æ¨¡è©¦ ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚° 2", "TOEIC L&R TEST ç²¾é¸æ¨¡è©¦ ç·åˆ",
    "æ¥µã‚ã‚! TOEIC L&R TEST 990ç‚¹ ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç‰¹è¨“",
    "TOEIC L&R TEST 900ç‚¹ç‰¹æ€¥ ãƒ‘ãƒ¼ãƒˆ5&6", "TOEIC L&R TEST èª­è§£ç‰¹æ€¥ 2 ã‚¹ãƒ”ãƒ¼ãƒ‰å¼·åŒ–ç·¨", "TOEIC L&R TEST èª­è§£ç‰¹æ€¥ 5 ãƒ€ãƒ–ãƒ«ãƒ‘ãƒƒã‚»ãƒ¼ã‚¸ç·¨",
    "1é§…1é¡Œ! TOEIC L&R TEST èª­è§£ç‰¹æ€¥", "TOEIC L&R TEST åˆå¿ƒè€…ç‰¹æ€¥ã€€ãƒ‘ãƒ¼ãƒˆ7",
    "ä¸–ç•Œä¸€ã‚ã‹ã‚Šã‚„ã™ã„ TOEIC L&R TEST ã®æˆæ¥­ [Part 7 èª­è§£]",
    "TOEIC L&Rãƒ†ã‚¹ãƒˆ ç›´å‰ã®æŠ€è¡“", "TOEIC(R) L&Rãƒ†ã‚¹ãƒˆ è‡³é«˜ã®æ¨¡è©¦600å•",
    "TOEIC L&Rãƒ†ã‚¹ãƒˆ æ–‡æ³•ãƒ»èªå½™ãƒ»ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚° æ¨¡è©¦",
    "ãƒ©ãƒ€ãƒ¼ã‚·ãƒªãƒ¼ã‚º Level 1", "ãƒ©ãƒ€ãƒ¼ã‚·ãƒªãƒ¼ã‚º Level 2", "ãƒ©ãƒ€ãƒ¼ã‚·ãƒªãƒ¼ã‚º Level 3", "ãƒ©ãƒ€ãƒ¼ã‚·ãƒªãƒ¼ã‚º Level 4", "ãƒ©ãƒ€ãƒ¼ã‚·ãƒªãƒ¼ã‚º Level 5",
    "CNN ENGLISH EXPRESS", "ENGLISH JOURNAL",
    "ã‚¸ãƒ£ãƒ‘ãƒ³ãƒ»ã‚¿ã‚¤ãƒ ã‚ºç¤¾èª¬é›†", "é€Ÿèª­é€Ÿè´ãƒ»è‹±å˜èª Core 1900", "é€Ÿèª­é€Ÿè´ãƒ»è‹±å˜èª Business 1200",
    "ç©¶æ¥µã®ãƒ“ã‚¸ãƒã‚¹è‹±èªãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°", "è‹±èªã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚ã‹ã‚‹ï¼"
  ];

  // D. ğŸ¢ ç¤¾ä¼šäºº/TOEIC Ã— çŸ­æ–‡ (å˜èªãƒ»æ–‡æ³•ãƒ»Part5)
  const toeicShortBooks = [
    "TOEIC L&R TEST å‡ºã‚‹å˜ç‰¹æ€¥ é‡‘ã®ãƒ•ãƒ¬ãƒ¼ã‚º", "TOEIC L&R TEST å‡ºã‚‹å˜ç‰¹æ€¥ éŠ€ã®ãƒ•ãƒ¬ãƒ¼ã‚º", "TOEIC L&R TEST å‡ºã‚‹å˜ç‰¹æ€¥ é‡‘ã®ã‚»ãƒ³ãƒ†ãƒ³ã‚¹",
    "TOEIC L&R TEST æš—é»’ã®ãƒ•ãƒ¬ãƒ¼ã‚º", "TOEIC L&R TEST ä¸Šç´šå˜èªç‰¹æ€¥ é»’ã®ãƒ•ãƒ¬ãƒ¼ã‚º",
    "TOEIC L&Rãƒ†ã‚¹ãƒˆ æ–‡æ³•å•é¡Œ ã§ã‚‹1000å•", "TOEIC L&Rãƒ†ã‚¹ãƒˆ æ–‡æ³•å•é¡Œ ã§ã‚‹1000å• å¾¹åº•è§£æ˜",
    "1é§…1é¡Œ! TOEIC L&R TEST æ–‡æ³•ç‰¹æ€¥", "1é§…1é¡Œ! TOEIC L&R TEST æ–‡æ³•ç‰¹æ€¥ 2 æ€¥æ‰€ã‚¢ã‚¿ãƒƒã‚¯ç·¨",
    "TOEIC L&R TEST 900ç‚¹ç‰¹æ€¥ ãƒ‘ãƒ¼ãƒˆ5&6", "TOEIC L&R TEST ãƒ‘ãƒ¼ãƒˆ5ç‰¹æ€¥ 420å•ãƒ‰ãƒªãƒ«",
    "ä¸–ç•Œä¸€ã‚ã‹ã‚Šã‚„ã™ã„ TOEIC L&R TEST ã®æˆæ¥­ [Part 5&6 æ–‡æ³•]",
    "ã‚­ã‚¯ã‚¿ãƒ³ TOEIC L&Rãƒ†ã‚¹ãƒˆ SCORE 600", "ã‚­ã‚¯ã‚¿ãƒ³ TOEIC L&Rãƒ†ã‚¹ãƒˆ SCORE 800", "ã‚­ã‚¯ã‚¿ãƒ³ TOEIC L&Rãƒ†ã‚¹ãƒˆ SCORE 990",
    "TOEIC L&R TEST è‹±å˜èªã‚¹ãƒ”ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ¼", "TOEIC L&R TEST å¿…ãšâ˜†ã§ã‚‹å˜ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ¼",
    "ä¸€å„„äººã®è‹±æ–‡æ³•", "ãƒãƒ¼ãƒˆã§æ„Ÿã˜ã‚‹è‹±æ–‡æ³•", "ç·åˆè‹±èª Evergreen",
    "è¡¨ç¾ã®ãŸã‚ã®å®Ÿè·µãƒ­ã‚¤ãƒ¤ãƒ«è‹±æ–‡æ³•", "ãƒ“ã‚¸ãƒã‚¹è‹±èªã®æ•¬èª", "è‹±ä¼šè©±ãƒšãƒ©ãƒšãƒ©ãƒ“ã‚¸ãƒã‚¹100",
    "NHK ãƒ©ã‚¸ã‚ªè‹±ä¼šè©±", "ç¬é–“è‹±ä½œæ–‡ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°"
  ];

  // =========================================================
  // æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯
  // =========================================================

  // ğŸ“ å­¦ç”Ÿãƒ¢ãƒ¼ãƒ‰
  if (mode === "STUDENT") {
    if (isLong) {
      const picks = shuffle(studentLongBooks).slice(0, 2);
      return {
        title: "ğŸ›¡ï¸ å¿—æœ›æ ¡æ”»ç•¥ï¼šé•·æ–‡èª­è§£ã®æ­¦å™¨",
        items: picks.map((title) => ({ title, url: makeRakutenLink(title) })),
      };
    } else {
      const picks = shuffle(studentShortBooks).slice(0, 2);
      return {
        title: "ğŸ”¥ å…¥è©¦åŸºç¤ï¼šå˜èªã¨æ–‡æ³•ã‚’æ¥µã‚ã‚‹",
        items: picks.map((title) => ({ title, url: makeRakutenLink(title) })),
      };
    }
  }

  // ğŸ¢ ç¤¾ä¼šäºº/TOEICãƒ¢ãƒ¼ãƒ‰
  if (mode === "TOEIC") {
    if (isLong) {
      const picks = shuffle(toeicLongBooks).slice(0, 2);
      return {
        title: "ğŸ¢ ã‚¹ã‚³ã‚¢ç›´çµï¼šPart7ãƒ»æ¨¡è©¦ãƒ»å¤šèª­",
        items: picks.map((title) => ({ title, url: makeRakutenLink(title) })),
      };
    } else {
      const picks = shuffle(toeicShortBooks).slice(0, 2);
      return {
        title: "âš¡ï¸ éš™é–“æ™‚é–“ã§ï¼šå˜èªãƒ»æ–‡æ³•ã‚¹ã‚³ã‚¢ã‚¢ãƒƒãƒ—",
        items: picks.map((title) => ({ title, url: makeRakutenLink(title) })),
      };
    }
  }

  return null;
};

